# Reliable Distributed PostgreSQL (RDPG) BOSH release

## License

MIT, see LICENSE file.

## Usage: Configuration & Delpoyment

We will walk through an example of using with Cloud Foundry.

To use this bosh release, first upload it to your bosh:

```sh
bosh target $BOSH_HOST
git clone https://.../rdpg-boshrelease.git
cd rdpg-boshrelease
bosh upload release releases/rdpg-1.yml
```

Next download your manifest file for the deployment targeted so we can edit it and add the release.

```sh
mkdir -p ~/workspace/manifests
bosh download manifest rdpg-development ~/workspace/manifests/rdpg.yml
bosh deployment ~/workspace/manifests/rdpg.yml
```

Alternatively, you can make your manifest. For example to prepare a manifest for 
bosh-lite (warden) using the 'centos' stemcell we would do the following:

```sh
STEMCELL_OS=centos ./prepare manifest warden
```


Edit the manifest file you downloaded (`~/workspace/manifests/rdpg.yml`) and add settings as follows.

Add to the list of known `releases: `

```yaml
releases:
#...
- name: rdpg
  version: latest
```

For consistency also add to the `releases: ` section under `meta: `

```yaml
meta:
  environment: rdpg-development
  releases:
  - name: cf
    version: latest
  - name: rdpg
    version: latest
```

Add properties such as tags.

```yaml
properties:
# ... lots of properties ... at bottom put vv
  rdpg:
```

Now, for every `instances: ` entry you wish to collocate this release with under `jobs:` add the following in the `templates: ` section:

```yaml
  - name: rdpg
    release: rdpg
```

Now you can deploy,

```yaml
bosh -n deploy
```

Note that for each job you create in your release that you want to run on a 
Job VM you must add a `templates:` entry with the `name:` of the template
and the `release:` from which it comes.

## Deployments Blobs

The script `prepare blobs` is used to prepare the `blobs/` directory
runs each package's `prepare` script from within the `blobs/`
directory. This will run each package's `prepare` script, if it exists,
which *should* download and prepare that package's required blobs 
(source tarballs, etc...) into the {package}/ directory.

## Development

Download your manifest file for the deployment targeted.

```sh
bosh target {{BOSH_DIRECTOR_URL/IP}}:25555
mkdir -p ~/workspace/manifests
bosh download manifest rdpg-development ~/workspace/manifests/rdpg-development.yml
bosh deployment ~/workspace/manifests/rdpg-development.yml
```

Make your changes to the release and then create a new development release by running:

```sh
bosh create release --with-tarball --force && bosh -n upload release
```

For the two release `version: ` entries change 'latest' to the '0+dev.N' version generated by the above command. Deploy your changes to take effect in the BOSH environment you have targeted.

```sh
bosh -n deploy
```

If you want to test your changes on one specific job, say `rdpg/0`, instead of all jobs:

```sh
bosh -n recreate rdpg 0 --force
bosh ssh rdpg 0 # Hop on and have a look around...
```

Note, to restart all processes Monit on a host run the following command as root on the host.

```sh
monit summary | awk -F\' '/Process/{print$2}' | xargs -n1 monit restart
```

