#!/var/vcap/packages/bash-4.3/bin/bash

source "$(dirname $(dirname ${0}))/shell/env"

ulimit -v unlimited

if (( $UID == 0 ))
then setcap cap_net_bind_service=+ep $(readlink -nf ${pkgPath}/bin/${jobName})
fi

user chown ${storePath}

if ! grep -q 127.0.0.1 /etc/resolv.conf
then sed -i -e '1i nameserver 127.0.0.1' /etc/resolv.conf
fi

binaryArgs=()
for _path in $(find $(dirname ${storePath}) -type d -name consul)
do binaryArgs+=(-config-dir ${_path})
done

if [[ -z ${1:-} ]] ; then fail "$0 start|stop" ; fi ; action=$1 ; shift 
case ${action} in
  (start)
    echo $$ > ${pidFile}
    ( 
    user run ${pkgPath}/bin/${jobName} agent \
      -server \
      -bootstrap-expect ${#consulNodes[@]} \
      -pid-file "${pidFile}" \
      -data-dir "${storePath}" \
      -config-dir "${jobPath}/config" ${binaryArgs[@]}
    ) &

    # TODO: Instead of using sleep, how do we test if the consul server is ready 
    #       to process joins?
    sleep 3

    user exec ${pkgPath}/bin/consul join "${consulNodes[@]}"
    ;;
  (stop)
    ${jobPath}/bin/consul leave
    send_signal TERM
    ;;
  (*)
    fail "Unknown action ${action}"
    ;;
esac

