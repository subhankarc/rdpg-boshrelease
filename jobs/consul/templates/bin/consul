#!/var/vcap/packages/bash-4.3/bin/bash

source "$(dirname $(dirname ${0}))/shell/env"

( user run ${binary} agent -server -bootstrap-expect ${#consulNodes[@]} \
  "${binaryArgs[@]}" ) &

# TODO: Instead of using sleep, how do we test if the consul server is ready 
#       to process joins?
sleep 3

user run ${binary} join "${consulNodes[@]}"

sleep 3

if [[ $(curl http://127.0.0.1:${consulPort}/v1/health/service/master) == "[]" ]]
then # TODO: This isn't quite right being here, move to an 'rdpg' job.
  curl -X PUT -d '{ "ID": "pgbdrc", "Name": "master", "Address": "'${consulNodes[0]}'", "Port": '${haproxyWritePort}', "Check": { "script": "/var/vcap/jobs/consul/bin/check ha_pgb_pg", "Interval": "10s"}} '\
  http://127.0.0.1:${consulPort}/v1/agent/service/register
fi

