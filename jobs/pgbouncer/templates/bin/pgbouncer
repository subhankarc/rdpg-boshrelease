#!/var/vcap/packages/bash-4.3/bin/bash

source "$(dirname $(dirname ${0}))/shell/env"

ulimit -v unlimited

action=$1 ; shift 

if [[ -z ${action:-} ]]
then fail "$0 start|reload"
fi

case ${action} in
  (start)
    for file in pgbouncer.ini users
    do
      if ! [[ -s ${storePath}/config/${file} ]]
      then cp ${jobPath}/config/${file} ${storePath}/config/${file}
      fi
    done
    user chown ${storePath}
    user exec ${pkgPath}/bin/${jobName} -d ${storePath}/config/pgbouncer.ini
    ;;
  (stop)
    send_signal TERM 
    ;;
  (reload)
    user exec ${pkgPath}/bin/${jobName} -R ${storePath}/config/pgbouncer.ini &
    ;;
  (console)
    exec /var/vcap/packages/pgbdr/bin/psql -U ${pgbAdminUser} --host 127.0.0.1 --port ${pgbListenPort} pgbouncer
    ;;
  (*)
    fail "$0 ${action} :: unkown action"
    ;;
esac
