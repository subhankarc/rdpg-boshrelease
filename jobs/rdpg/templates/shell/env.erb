#!/var/vcap/packages/bash-4.3/bin/bash

set -e # exit immediately if a simple command exits with a non-zero status
set -u # report the usage of uninitialized variables

vmName="<%= name %>" # BOSH VM name
vmIndex="<%= index %>" # Index within cluster
deploymentName="<%= spec.deployment %>"
domainName="<%= spec.dns_domain_name %>"
vmFullName="${vmName}/${vmIndex}" # full job name
nodeName="${deploymentName}-${vmName}-${vmIndex}"

jobName="rdpg"

logPath="/var/vcap/sys/log/${jobName}"
mkdir -p "${logPath}"
exec &> >(tee -a "${logPath}/${jobName}.log") # STD{OUT,ERR}
echo -e "$(date +'%Y-%m-%dT%H:%M:%S') $(whoami) > $0 $*"

source /var/vcap/jobs/${jobName}/shell/functions

<% if p('rdpg.debug') == "true" %>turn_debugging_on<% end %>

jobPath="/var/vcap/jobs/${jobName}"
pkgPath="/var/vcap/packages/${jobName}"
runPath="/var/vcap/sys/run/${jobName}"
tmpPath="/var/vcap/sys/tmp/${jobName}"
storePath="/var/vcap/store/${jobName}"

userName="vcap"
groupName="vcap"
LANG="en_US.UTF-8"
HOME="${HOME:-"/home/${userName}"}"
pidFile="${runPath}/${jobName}.pid"
binary="${pkgPath}/bin/${jobName}"
binaryArgs=()
LD_LIBRARY_PATH="${LD_LIBRARY_PATH:-}"
export LANG HOME LD_LIBRARY_PATH

consulPort="<%= p('consul.port','8500') %>"
consulCheckScript="$(dirname ${jobPath})/consul/bin/check"
rdpgDB="<%= p('rdpg.db_name') %>"
rdpgUser="<%= p('rdpg.db_user') %>"
pgbdrPort="<%= p('pgbdr.port') %>"
rdpgPass="<%= p('rdpg.db_pass') %>"
hapTimeoutConnect="<%=p('haproxy.timeout_connect').to_s %>"
hapTimeoutClient="<%= p('haproxy.timeout_client') %>"
hapTimeoutServer="<%= p('haproxy.timeout_server') %>"
hapAdminUser="<%= p('haproxy.admin_user').to_s %>"
hapAdminPass="<%= p('haproxy.admin_pass').to_s %>"
hapStatsPort="<%= p('haproxy.stats_port').to_s %>"
hapPort="<%= p('haproxy.port','') %>"
hapWritePort="<%= p('haproxy.write_port').to_s %>"
hapReadPort="<%= p('haproxy.read_port').to_s %>"
hapMaxConn="<%= p('haproxy.max_conn','2048').to_s %>"
nodeName="${deploymentName}-${vmName}-${vmIndex}"
pgbPort="<%=p('pgbouncer.listen_port').to_s %>"
pgbAdminPass="<%= p('pgbouncer.admin_pass') %>"
pgbAdminUser="<%= p('pgbouncer.admin_user') %>"
pgbAuthType="<%= p('pgbouncer.auth_type') %>"
pgbListenAddr="<%= p('pgbouncer.listen_addr') %>"
pgbListenPort="<%= p('pgbouncer.listen_port') %>"
pgbPoolMode="<%= p('pgbouncer.pool_mode') %>"
pgbConfigPath="$(dirname ${jobPath})/pgbouncer"
hapConfigFile="/var/vcap/jobs/haproxy/config/haproxy.cfg"
hapConfigTmpl="/var/vcap/jobs/haproxy/config/haproxy.cfg.ctmpl"
ctConfigPath="/var/vcap/jobs/consul-template/config"
ctUser="<%= p('consul_template.user_name') %>"
ctPass="<%= p('consul_template.password') %>"
consulPort="<%= p('consul.port') %>"
selfIP="<%= p('rdpg.nodes').each_with_index.map{|node,i| (i == index) ? node : nil}.first.to_s %>"
nodes=(<% p('rdpg.nodes').each do |node| %> <%= node %> <% end %>)

add_packages_to_path

configure_job_paths

if ! [[ -d ${jobPath}/config && -s ${jobPath}/config/pgpass ]]
then
  mkdir -p ${jobPath}/config
  user chown ${jobPath}/config
  echo "*:*:*:${rdpgUser}:${rdpgPass}" > ${jobPath}/config/pgpass 
  cp ${jobPath}/config/pgpass /home/vcap/.pgpass 
  touch /home/vcap/.pgpass
  user chown ${jobPath}/config/pgpass 
  user chown /home/vcap/.pgpass
  chmod 0600 ${jobPath}/config/pgpass  /home/vcap/.pgpass
fi

set_pid
