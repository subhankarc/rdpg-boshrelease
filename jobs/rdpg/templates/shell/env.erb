#!/var/vcap/packages/bash-4.3/bin/bash

set -e # exit immediately if a simple command exits with a non-zero status
set -u # report the usage of uninitialized variables

jobName="rdpg"
vmName="<%= name %>" # BOSH VM name
vmIndex="<%= index %>" # Index within cluster
deploymentName="<%= spec.deployment %>"
domainName="<%= spec.dns_domain_name %>"
vmFullName="${vmName}/${vmIndex}" # full job name
nodeName="${deploymentName}-${vmName}-${vmIndex}"

logPath="/var/vcap/sys/log/${jobName}"
mkdir -p "${logPath}"
exec &>> "${logPath}/${jobName}.log" # STD{OUT,ERR}
echo -e "$(date +'%Y-%m-%dT%H:%M:%S') $(whoami) > $0 $*"

source /var/vcap/jobs/${jobName}/shell/functions

<% if p('rdpg.debug') == "true" %>turn_debugging_on<% end %>

jobPath="/var/vcap/jobs/${jobName}"
pkgPath="/var/vcap/packages/${jobName}"
runPath="/var/vcap/sys/run/${jobName}"
tmpPath="/var/vcap/sys/tmp/${jobName}"
storePath="/var/vcap/store/${jobName}"

userName="vcap"
groupName="vcap"
LANG="en_US.UTF-8"
HOME="${HOME:-"/home/${userName}"}"
pidFile="${runPath}/${jobName}.pid"
LD_LIBRARY_PATH="${LD_LIBRARY_PATH:-}"
export LANG HOME LD_LIBRARY_PATH

RDPG_AGENT_LOG_LEVEL="<%= p('rdpg.agent_log_level') %>"
RDPG_SB_PORT="<%= p('rdpg.agent_sb_port') %>"
RDPG_SB_USER="<%= p('rdpg.agent_sb_user') %>"
RDPG_SB_PASS="<%= p('rdpg.agent_sb_pass') %>"
RDPG_ADMIN_PORT="<%= p('rdpg.agent_admin_port') %>"
RDPG_ADMIN_USER="<%= p('rdpg.agent_admin_user') %>"
RDPG_ADMIN_PASS="<%= p('rdpg.agent_admin_pass') %>"
RDPG_ADMIN_PG_URI="<%= p('rdpg.agent_admin_pg_uri') %>"
RDPG_AGENT_PIDFILE=${pidFile}
export RDPG_AGENT_PIDFILE RDPG_AGENT_LOG_LEVEL RDPG_SB_PORT RDPG_SB_USER RDPG_SB_PASS RDPG_ADMIN_PORT RDPG_ADMIN_USER RDPG_ADMIN_PASS RDPG_ADMIN_PG_URI

rdpgDB="<%= p('rdpg.db_name') %>"
rdpgUser="<%= p('rdpg.db_user') %>"
rdpgPass="<%= p('rdpg.db_pass') %>"
pgPort="<%= p('pgbdr.port') %>"

# TODO: The following will disappear when their configuration goes into rdpg-agent
pgbPort="<%= p('pgbouncer.listen_port').to_s %>"
nodes=(<% p('rdpg.nodes').each do |node| %> <%= node %> <% end %>)

add_packages_to_path

configure_job_paths

if ! [[ -d ${jobPath}/config && -s ${jobPath}/config/pgpass ]]
then
  mkdir -p ${jobPath}/config
  user chown ${jobPath}/config
  echo "*:*:*:${rdpgUser}:${rdpgPass}" > ${jobPath}/config/pgpass 
  cp ${jobPath}/config/pgpass /home/vcap/.pgpass 
  touch /home/vcap/.pgpass
  user chown ${jobPath}/config/pgpass 
  user chown /home/vcap/.pgpass
  chmod 0600 ${jobPath}/config/pgpass  /home/vcap/.pgpass
fi

# Update Lost+Found to allow null re-direct for Consul check
chmod 0744 /var/vcap/store/lost+found

set_pid

