#!/var/vcap/packages/bash-4.3/bin/bash

source "$(dirname $(dirname ${0}))/shell/env"

trap graceful_stop SIGTERM # Handle term signal sent by control script stop action.

echo $$ > ${pidFile} # Write the shell script's PID to the pidFile

# TODO: Move pg_hba.conf configuration into here?
initialize_rdpg_db

# Configure initial databases for pgbouncer:
configure_pgbouncer

# Configure Initial HAProxy:
configure_haproxy

# Configure Consul:
configure_consul

while ! [[ -s ${storePath}/consul/rdpg-services.json ]]
do sleep 1 # Wait for consul service configuration file to drop
done

/var/vcap/bosh/bin/monit restart consul

while ! [[ -s /var/vcap/jobs/consul-template/config/rdpg.json ]]
do sleep 1 # Wait for consul-template rdpg config file to drop.
done

# Configure Consul Template:
configure_consul_template

while (( $(number_of_joined_nodes) < ${#nodes[@]} ))
do sleep 1 # Wait for the bdr cluster to be online before starting the agent.
done

if (( ${vmIndex} == 0 ))
then ${binary} init
fi

exec ${binary}

