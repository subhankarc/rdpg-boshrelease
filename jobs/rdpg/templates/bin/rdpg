#!/var/vcap/packages/bash-4.3/bin/bash

source "$(dirname $(dirname ${0}))/shell/env"

set_pid
if (( ${pid} == 0 )) ; then echo $$ > ${pidFile} ; fi

if [[ -z ${1:-} ]] ; then fail "$0 start|stop" ; fi ; action=$1 ; shift 
case ${action} in
  (start)
    # TODO: Move pg_hba.conf configuration into here?
    initialize_rdpg_db

    # Configure initial databases for pgbouncer:
    configure_pgbouncer

    # Configure Initial HAProxy:
    configure_haproxy

    # Configure Consul:
    configure_consul

    while ! [[ -s ${storePath}/consul/rdpg-services.json ]]
    do sleep 1 # Wait for consul service configuration file to drop
    done

    /var/vcap/bosh/bin/monit restart consul

    while ! [[ -s /var/vcap/jobs/consul-template/config/rdpg.json ]]
    do sleep 1 # Wait for consul-template rdpg config file to drop.
    done

    # Configure Consul Template:
    configure_consul_template

    while (( $(number_of_joined_nodes) < ${#nodes[@]} ))
    do sleep 1 # Wait for the bdr cluster to be online before starting the agent.
    done

    register_write_master

    if (( ${vmIndex} == 0 ))
    then # TODO: Also only need to run this the first time
      ${pkgPath}-agent/bin/rdpg-agent init
    fi

    exec ${pkgPath}-agent/bin/rdpg-agent
    ;;
  (stop)
    send_signal TERM 
    exit 0
    ;;
  (init)
    ${pkgPath}-agent/bin/rdpg-agent init
    ;;
  (*)
    fail "Unknown action ${action}"
    ;;
esac

