#!/usr/bin/env bash

mkdir -p "/var/vcap/sys/log/pgbdr/"
exec &>> "/var/vcap/sys/log/pgbdr/pgbdr.log"
echo -e "$(date +'%Y-%m-%dT%H:%M:%S')\$> $0 $*"

set -e # exit immediately if a simple command exits with a non-zero status
set -u # report the usage of uninitialized variables

vmName="<%= name %>" # BOSH VM name
vmIndex="<%= index %>" # Index within cluster
vmFullName="${vmName}/${vmIndex}" # full job name
jobName="${vmName}"

source "/var/vcap/jobs/${jobName}/shell/functions"

jobPath="/var/vcap/jobs/${jobName}"
runPath="/var/vcap/sys/run/${jobName}"
logPath="/var/vcap/sys/log/${jobName}"
tmpPath="/var/vcap/sys/tmp/${jobName}"
storePath="/var/vcap/store/${jobName}"
pkgPath="/var/vcap/packages/pgbdr"
dataPath="${storePath}/data"

userName=vcap
groupName=vcap
LANG="en_US.UTF-8"
HOME="${HOME:-"/home/${userName}"}"
binary="${pkgPath}/bin/pg_ctl"
binaryArgs=(-D ${dataPath} -s)
pidFile="${runPath}/${jobName}.pid"
LD_LIBRARY_PATH="/var/vcap/packages/pgbdr/lib"

# Add all packages' /bin & /sbin into $PATH
for _path in $(ls -d /var/vcap/packages/*/*bin)
do PATH="${_path}:${PATH}"
done

export PATH LANG HOME LD_LIBRARY_PATH

paths=(
"${jobPath}"
"${runPath}"
"${logPath}"
"${tmpPath}"
"${storePath}"
)

for _path in "${paths[@]}"
do
  if ! [[ -d ${_path} ]]
  then
    mkdir -p "${_path}"
    chown -R ${userName}:${groupName} "${_path}"
    chmod 0775 "${_path}"
  fi
done

if [[ ! -d ${dataPath} ]]
then 
  chown -R ${userName}:${groupName} ${storePath}
  pushd ${storePath}
  HOME=${storePath} chpst -u ${userName}:${groupName} ${pkgPath}/bin/initdb \
    -E UTF8 --local "en_US.UTF-8" -D ${dataPath}
  popd
fi

sed -i ${dataPath}/postgresql.conf \
  -e "s%^.*external_pid_file.*$\$%external_pid_file = '${pidFile}'%" \
  -e "s/^.*shared_preload_libraries.*\$/shared_preload_libraries = 'bdr'/" \
  -e "s/^.*wal_level.*\$/wal_level = 'logical'/" \
  -e "s/^.*track_commit_timestamp.*\$/track_commit_timestamp = on/" \
  -e "s/^.*max_connections*\$/max_connections = 100/" \
  -e "s/^.*max_wal_senders.*\$/max_wal_senders = 10/" \
  -e "s/^.*max_replication_slots.*\$/max_replication_slots = 10/" \
  -e "s/^.*max_worker_processes.*\$/max_worker_processes = 96/" \
  -e "s/^.*log_error_verbosity.*\$/log_error_verbosity = verbose/" \
  -e "s/^.*log_min_messages.*\$/log_min_messages = debug1/" \
  -e "s/^.*log_line_prefix.*\$/log_line_prefix = 'd=%d p=%p a=%a%q '/" \
  -e "s/^.*bdr.default_apply_delay.*\$/bdr.default_apply_delay=2000   # milliseconds/" \
  -e "s/^.*bdr.log_conflicts_to_table.*\$/bdr.log_conflicts_to_table=on/"

