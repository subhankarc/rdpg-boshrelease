#!/usr/bin/env bash

mkdir -p "/var/vcap/sys/log/pgbdr/"
exec &>> "/var/vcap/sys/log/pgbdr/pgbdr.log"
echo -e "$(date +'%Y-%m-%dT%H:%M:%S')\$> $0 $*"

set -e # exit immediately if a simple command exits with a non-zero status
set -u # report the usage of uninitialized variables

vmName="<%= name %>" # BOSH VM name
vmIndex="<%= index %>" # Index within cluster
vmFullName="${vmName}/${vmIndex}" # full job name
jobName="pgbdr"

source "/var/vcap/jobs/${jobName}/shell/functions"

<% if p('pgbdr.debug') == "true" %>turn_debugging_on<% end %>

jobPath="/var/vcap/jobs/${jobName}"
runPath="/var/vcap/sys/run/${jobName}"
logPath="/var/vcap/sys/log/${jobName}"
tmpPath="/var/vcap/sys/tmp/${jobName}"
storePath="/var/vcap/store/${jobName}"
pkgPath="/var/vcap/packages/pgbdr"
dataPath="${storePath}/data"

userName=vcap
groupName=vcap
LANG="en_US.UTF-8"
HOME="${HOME:-"/home/${userName}"}"
binary="${pkgPath}/bin/pg_ctl"
binaryArgs=(-D ${dataPath} -s)
pidFile="${dataPath}/postmaster.pid"
LD_LIBRARY_PATH="${pkgPath}/lib"
export LANG HOME LD_LIBRARY_PATH

rdpgUser="<%= p('rdpg.db_user') %>"
pgPort="<%= p('pgbdr.port','5432') %>"
pgbdrHBA="<%= p('pgbdr.hba') %>"
pgbdrMaxConnections="<%= p('pgbdr.max_connections') %>"
pgbdrSharedBuffers="<%= p('pgbdr.shared_buffers') %>"
pgbdrEffectiveCacheSize="<%= p('pgbdr.effective_cache_size') %>"
pgbdrWorkMem="<%= p('pgbdr.work_mem') %>"
pgbdrMaintenanceWorkMem="<%= p('pgbdr.maintenance_work_mem') %>"
pgbdrCheckpointSegments="<%= p('pgbdr.checkpoint_segments') %>"
pgbdrCheckpointCompletionTarget="<%= p('pgbdr.checkpoint_completion_target') %>"
pgbdrWALBuffers="<%= p('pgbdr.wal_buffers') %>"
pgbdrDefaultStatisticsTarget="<%= p('pgbdr.default_statistics_target') %>"
pgbdrMaxWorkerProcesses="<%= p('pgbdr.max_worker_processes') %>"
pgbdrMaxReplicationSlots="<%= p('pgbdr.max_replication_slots') %>"
pgbdrMaxWalSenders="<%= p('pgbdr.max_wal_senders') %>"
pgbdrLogErrorVerbosity="<%= p('pgbdr.log_error_verbosity') %>"
pgbdrLogLinePrefix="<%= p('pgbdr.log_line_prefix') %>"
pgbdrLogMinMessages="<%= p('pgbdr.log_min_messages') %>"
pgbdrLogMinErrorStatement="<%= p('pgbdr.log_min_error_statement') %>"
pgbdrLogMinDurationStatement="<%= p('pgbdr.log_min_duration_statement') %>"
pgbdrDefaultApplyDelay="<%= p('pgbdr.default_apply_delay') %>"

nodes=( <% p('rdpg.nodes').each do |node| %> <%= node %> <% end %> )

add_packages_to_path

configure_job_paths

